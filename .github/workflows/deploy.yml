name: Deploy DDNS Worker

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Deploy (Hidden URL)
        env:
          # 认证信息
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          # Worker 需要的 Secrets (先映射到环境变量)
          SECRET_CF_API_KEY: ${{ secrets.CF_API_KEY }}
          SECRET_CF_API_EMAIL: ${{ secrets.CF_API_EMAIL }}
          SECRET_API_SECRET: ${{ secrets.API_SECRET }}
          SECRET_DEFAULT_TTL: ${{ secrets.DEFAULT_TTL }}
          SECRET_TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          SECRET_TG_CHANNEL_ID: ${{ secrets.TG_CHANNEL_ID }}
        shell: bash
        run: |
          # 自动上传 Secrets 到 Cloudflare (保持静默防止泄漏)
          # 如果变量存在，则上传；上传日志重定向到 /dev/null 保持清洁
          echo "Uploading secrets..."
          
          [ -n "$SECRET_CF_API_KEY" ] && echo "$SECRET_CF_API_KEY" | npx wrangler secret put CF_API_KEY >/dev/null 2>&1
          [ -n "$SECRET_CF_API_EMAIL" ] && echo "$SECRET_CF_API_EMAIL" | npx wrangler secret put CF_API_EMAIL >/dev/null 2>&1
          [ -n "$SECRET_API_SECRET" ] && echo "$SECRET_API_SECRET" | npx wrangler secret put API_SECRET >/dev/null 2>&1
          
          # 可选 Secrets
          [ -n "$SECRET_DEFAULT_TTL" ] && echo "$SECRET_DEFAULT_TTL" | npx wrangler secret put DEFAULT_TTL >/dev/null 2>&1
          [ -n "$SECRET_TG_BOT_TOKEN" ] && echo "$SECRET_TG_BOT_TOKEN" | npx wrangler secret put TG_BOT_TOKEN >/dev/null 2>&1
          [ -n "$SECRET_TG_CHANNEL_ID" ] && echo "$SECRET_TG_CHANNEL_ID" | npx wrangler secret put TG_CHANNEL_ID >/dev/null 2>&1

          echo "Secrets uploaded. Starting deployment..."

          # 部署并使用 sed 过滤掉 workers.dev 的链接
          # 2>&1 确保错误日志中的链接也会被隐藏
          npx wrangler deploy 2>&1 | sed -E 's/https:\/\/[a-zA-Z0-9.-]+\.workers\.dev/**HIDDEN_URL**/g'
