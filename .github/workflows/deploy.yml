name: Deploy DDNS Worker

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Cloudflare Workers
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Deploy (Hidden URL)
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          SECRET_CF_DNS_API_TOKEN: ${{ secrets.CF_DNS_API_TOKEN }}
          SECRET_API_SECRET: ${{ secrets.API_SECRET }}
          SECRET_DEFAULT_TTL: ${{ secrets.DEFAULT_TTL }}
          SECRET_TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          SECRET_TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        shell: bash
        run: |
          echo "Uploading secrets..."
          
          # 上传新的 DNS Token
          [ -n "$SECRET_CF_DNS_API_TOKEN" ] && echo "$SECRET_CF_DNS_API_TOKEN" | npx wrangler secret put CF_DNS_API_TOKEN >/dev/null 2>&1
          
          # 其他 Secrets
          [ -n "$SECRET_API_SECRET" ] && echo "$SECRET_API_SECRET" | npx wrangler secret put API_SECRET >/dev/null 2>&1
          [ -n "$SECRET_DEFAULT_TTL" ] && echo "$SECRET_DEFAULT_TTL" | npx wrangler secret put DEFAULT_TTL >/dev/null 2>&1
          [ -n "$SECRET_TG_BOT_TOKEN" ] && echo "$SECRET_TG_BOT_TOKEN" | npx wrangler secret put TG_BOT_TOKEN >/dev/null 2>&1
          [ -n "$SECRET_TG_CHAT_ID" ] && echo "$SECRET_TG_CHAT_ID" | npx wrangler secret put TG_CHAT_ID >/dev/null 2>&1

          echo "Secrets uploaded. Starting deployment..."
          npx wrangler deploy 2>&1 | sed -E 's/https:\/\/[a-zA-Z0-9.-]+\.workers\.dev/**HIDDEN_URL**/g'
